# 济宁国土执法项目 整理

## 总览
### 一、地图相关：
    1. arcgis地图基础搭建与使用
    2. arcgis地图基础的操作(绘制 取点 点击交互弹框)
    3. arcgis地图图层
    4. arcgis地图研判分析部分 以及 网格员部分
    
### 二、大屏相关：
    1. 数据滚动 数据格式
    2. 表格滚动
    3. 图表滚动
    4. 天气插件
    5. 大屏数据素材

### 三、websocket 相关
    1. 注册 创建链接
    2. 相应后端返回值
    3. 重连以及断网的操作


### 地图相关：

#### 1.arcgis地图基础搭建 
相关链接： https://developers.arcgis.com/javascript/latest/sample-code/intro-mapview/

```javascript
<script setup lang="ts">
    // 1.引入需要的依赖项
import Map from '@arcgis/core/Map'
import MapView from '@arcgis/core/views/MapView'
import { onMounted } from 'vue'

onMounted(() => {
    // 2.创建一个地图实例
  const map = new Map({
    basemap: 'topo-vector'
  })

  const view = new MapView({
    container: 'map',
    map,
    center: [116.6, 35.5],
    zoom: 8,
  })
})
</script>

<template>
    {/* 3.挂载到dom上 */}
  <div id="map" />
</template>

<style>
html,
body,
#app,
#map {
  height: 100%;
  width: 100%;
  margin: 0;
  padding: 0;
}
</style>

```

### 2.arcgis地图基础操作

### 2.1.基础操作 

#### 2.1.1 定位 复位

```javascript
  // 定位 注意：根据权限判断 例如两个区县权限 要展示全面
  function gotoPoint(longitude: number, latitude: number, range: number, deviation?: number) {
    const point = new Point({
      longitude: deviation ? Number(longitude) + deviation : longitude,
      latitude: deviation ? Number(latitude) - deviation / 2 : latitude,
      spatialReference: { wkid: 4326 }
    })
    view.goTo({ target: point, zoom: range })
  }

  // 复位
  function gotoReset() {
    view.goTo({
      target: new Point({
        longitude: center[0],
        latitude: center[1],
        spatialReference: { wkid: 4326 }
      }),
      zoom
    })
  }

```
####  2.1.2 工具栏： 
**画点 线 面的几何图形  sketch绘制 提供了丰富场景**

1、draw绘制-**自定义比较强**
https://developers.arcgis.com/javascript/latest/api-reference/esri-views-draw-Drawhtml

2、sketch绘制-**使用官方强大功能**
https://developers.arcgis.com/javascript/latest/sample-code/sketch-geometries/


### 2.2 添加图层

项目应用场景：
    1.**在主页地图的县市区的分界线**：就是添加的不同的图层 默认是区 通过不同的**唯一标识**来控制显示不同的图层
    2.**区域地块信息** 点击某个地块拿到**唯一标识** 去匹配图层中的符合项进行展示

```javascript
// 添加基础图层
import MapImageLayer from '@arcgis/core/layers/MapImageLayer'
const imageLayer = new MapImageLayer({
  url: 'http://222.173.156.235:6080/arcgis/rest/services/JNORCL/GEO_JN_XZQH/MapServer',
  visible: true,
  sublayers: [
    {
      id: 2,
      title: '县',
      renderer: new SimpleRenderer({
        symbol: new SimpleFillSymbol({
          color: [0, 0, 0, 0],
          outline: {
            color: '#05e4c6',
            width: 2.5,
          },
        }),
      }),
      labelsVisible: true,
      visible: true,
    },
  ],
})
map.add(imageLayer)
```

### 3. 研判分析
#### 3.1地块信息分析
https://developers.arcgis.com/javascript/latest/sample-code/ge-geodesicbuffer/
```javascript
// 测量、测面、判断相交等
import * as geometryEngine from '@arcgis/core/geometry/geometryEngine'

使用
geometryEngine.geodesicLength(geometry, unit)
geometryEngine.geodesicArea(geometry, unit)
geometryEngine.intersect(geometry1, geometry2) // 返回相交的地块信息 就可以进行图表数据展示
```

#### 3.2网格员

#### 3.2.1使用queryFeatures查询
查询到的数据添加到图层上 在中心点进行标识
```javascript
FeatureLayer.queryFeatures().then((results) => {
  console.log(results.features)
  // dosomething
})
```
```javascript
// 查询符合字段的features
const layer = new FeatureLayer({ url: Url })

const query = new Query()
query.where = 'STATE_NAME = 青岛'
query.outSpatialReference = { wkid: 4326 }
query.returnGeometry = true
query.outFields = ['*']

layer.queryFeatures(query).then((results) => {
  console.log(results.features)
  // dosomething
})
```
```javascript
// 传递一个geometry返回与之相交的features
const queryParams = layer.createQuery()
queryParams.geometry = geometry
queryParams.spatialRelationship = 'intersects'
layer.queryFeatures(queryParams).then((results) => {
  console.log(results.features)
  // dosomething
})
```

#### 3.2.2 编辑覆盖物
Editor进行layer编辑

引入Editor
```javascript
import Editor from '@arcgis/core/widgets/Editor'
```
使用
```javascript
const editor = new Editor({ view: MapView })
```

#### 3.2.3 Popup弹出窗
两种
第一种: 用arcgis自带的弹框效果 **自定义的效果差一些**
```javascript
const pictureMarker = new Graphic({
  geometry: new Point({
    longitude: 120,
    latitude: 36,
  }),
  symbol: new PictureMarkerSymbol({
    url: img,
    width: '64px',
    height: '64px',
  }),
  popupTemplate: {
    title: 'Vue',
    content: 'Vue is a progressive framework for building user interfaces.',
  },
})
```
第二种：**自定义性要强**
```javascript
view.popup.id = 'person'
view.popup.alignment = 'bottom-right'
const popupTemplate = {
  title: '执法人员详情',
  location: new Point({ longitude: info.longitude, latitude: info.latitude }),
  content: `<div class="flex-wrap flex-start peopleInfoWindow">
              <div class="item">姓名：${account}</div>
              <div class="item" ${sexName ? '' : 'style="display: none"'}>性别：${sexName}</div>
              <div class="item">手机号：${phone}</div>
              <div class="item">经度：${info.longitude}</div>
              <div class="item">纬度：${info.latitude}</div>
              <div class="item">所属区县：${postName}</div>
            </div>`
}
view.popup.open(popupTemplate)
```




### 大屏相关

#### 1.数据滚动 数据格式
使用的是CountUp.js  数据加载变化时 不生硬 有一个滚动效果

```javascript
const countUp = new CountUp('targetId', 5234, options);

countUp.start(someMethodToCallOnComplete);
// or an anonymous function
countUp.start(() => console.log('Complete!'));

<template>
  <div id='targetId'></div>
</template>
```

#### 2.表格滚动
编写动画  让表格内数据滚动到底部 在缓慢滚动到顶部  形成循环
**注意** 要找准滚动的容器  动画要平缓  

#### 3.图表滚动
使用echarts中的api action 
ECharts 中支持的图表行为，通过 **dispatchAction** 触发。

##### 3.1 图表行为 action
https://www.makeapie.cn/doc/echarts/zh/api.html#action
```javascript
// 如果要高亮系列：
dispatchAction({
    type: 'highlight',
    // 用 index 或 id 或 name 来指定系列。
    // 可以使用数组指定多个系列。
    seriesIndex?: number | number[],
    seriesId?: string | string[],
    seriesName?: string | string[],

    // 数据项的 index，如果不指定也可以通过 name 属性根据名称指定数据项
    dataIndex?: number | number[],
    // 可选，数据项名称，在有 dataIndex 的时候忽略
    name?: string | string[],
});
```

```javascript
// 如果要取消高亮系列：
dispatchAction({
    type: 'downplay',

    // 用 index 或 id 或 name 来指定系列。
    // 可以使用数组指定多个系列。
    seriesIndex?: number | number[],
    seriesId?: string | string[],
    seriesName?: string | string[],

    // 数据项的 index，如果不指定也可以通过 name 属性根据名称指定数据项
    dataIndex?: number | number[],
    // 可选，数据项名称，在有 dataIndex 的时候忽略
    name?: string | string[],
})
```

##### 3.2 配个鼠标移入移出事件 event
https://www.makeapie.cn/doc/echarts/zh/api.html#events

```javascript
const myChart = echarts.init(document.getElementById('mychart'))

// 鼠标移入 
myChart.on('mouseover', param => {
 dosomething...
})
// 鼠标移出
myChart.on('mouseover', param => {
 dosomething...
})
```

#### 4.天气插件 
**和风天气api**
https://dev.qweather.com/docs/start/


#### 5.大屏素材插件
dataV ：主要用于**构建大屏**（全屏）数据展示页面即**数据可视化**
vue react 版本都有
http://datav.jiaminghi.com/guide/
以上我们大屏的需求 应该都满足



### websocket 链接 通讯
使用plus-websocket
https://ext.dcloud.net.cn/plugin?id=647

使用方法：
https://uniapp.dcloud.net.cn/api/request/websocket.html# 